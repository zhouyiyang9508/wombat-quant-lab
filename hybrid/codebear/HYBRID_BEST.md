# 🏆 Hybrid 策略最优记录

更新时间: 2026-02-22 | 作者: 代码熊 🐻

---

## 当前冠军：Hybrid v5 策略D

**文件**: `hybrid_v5_dynbtceth.py`  
**架构**: 股票(v9j) + 加密(BTC/ETH 阈值切换+独立MA过滤)

### 核心参数

| 参数 | 值 |
|---|---|
| 股票端 | v9j 月频信号 + 日频P&L |
| Crypto 端 | BTC + ETH，月频动量信号 |
| 权重切换逻辑 | 动量差 >5% → 80:20；<5% → 50:50 |
| MA 过滤 | BTC/ETH **各自独立** 200dMA（BTC跌不影响ETH） |
| 波动率目标 | BTC 60日vol → 目标80%/年 |
| BTC 回撤保护 | DD<-25% 退出 → <-15% 恢复 |
| 交易成本 | 0.15% 单边 |

### 推荐配置（IS=2015-20，OOS=2021-25，日频MaxDD）✅ 前瞻偏差已修复

| w_crypto | CAGR | MaxDD | Sharpe | WF | IS_S | OOS_S |
|---|---|---|---|---|---|---|
| 15% | 44.8% | -22.8% | 1.74 | 0.649 ✅ | 2.06 | 1.34 |
| **20%** | **48.3%** | **-22.1%** | **1.74** | **0.640** ✅ | 2.06 | 1.32 |
| **25%** | **51.7%** | **-25.1%** | **1.70** | **0.635** ✅ | 2.01 | 1.28 |
| 30% | 55.0% | -29.5% | 1.65 | 0.630 ✅ | 1.95 | 1.23 |

> ✅ MaxDD 为真实**日频**数据（非月频估算）  
> ✅ 所有数字已修复前瞻偏差（MA 过滤使用 prev_day 价格）  
> 推荐 **w=20%**（WF 0.640，CAGR 48.3%）或 w=25%（更高 CAGR，MaxDD 略升）

### vs v3 基准（修复后对比）

| 指标 | v3 修复后 (w=20%) | v5-D 修复后 (w=20%) | 改进 |
|---|---|---|---|
| CAGR | 47.7% | **48.3%** | +0.6% ↑ |
| MaxDD | -22.0% | **-22.1%** | 持平 |
| WF | 0.559 ❌ | **0.640** ✅ | **+0.081 ↑** |
| Sharpe | 1.91 | 1.74 | 略降 |

**v5-D 核心价值：WF 显著高于 v3 修复后（0.640 vs 0.559），v3 修复后已不满足 WF≥0.60 阈值。**

---

## 历史演进

| 版本 | 股票端 | Crypto端 | CAGR | WF | MaxDD |
|---|---|---|---|---|---|
| v2 | v9j daily | BTC+ETH 无过滤 | 32.2%~52.7% | <0.60 ❌ | — |
| v3 (bug) | v9j daily | BTC+ETH 200dMA+DD保护 | 52.7% | 0.600 | -22.0% |
| v3 (fixed) | v9j daily | BTC+ETH 200dMA+DD保护 | 47.7% | 0.559 ❌ | -22.0% |
| v4 | v11b daily | BTC+ETH+BNB+ADA+SOL | — | <0.58 ❌ | — |
| v5-D (bug) | v9j daily | BTC/ETH 独立MA+阈值 | 55.8% | 0.649 | -22.1% |
| **v5-D (fixed)** | **v9j daily** | **BTC/ETH 独立MA+阈值** | **48.3%** | **0.640** ✅ | **-22.1%** |

**关键教训:**
- 扩展 Crypto 池（v4）适得其反 → BTC+ETH 就是最优 Crypto 组合
- 独立 MA 过滤 > 联动 MA 过滤（允许 ETH 单独持有）
- 阈值切换比连续权重 WF 更高（减少噪音信号）

---

## 设计原则（固化）

1. **日频 P&L 追踪**：月频信号 + 日频执行，MaxDD 直接报告日频值，无需事后审计
2. **WF 分割点**：IS=2015-2020，OOS=2021-2025（与 v3 保持一致）
3. **WF 阈值**：≥0.60 为部署级，≥0.58 为可接受
4. **Composite 公式**：Sharpe×0.25 + Calmar×0.25 + min(CAGR,2.0)×0.50

---

## ⚠️ 重要修正（2026-02-22，小袋熊 Code Review 发现）

### Bug：日频 MA 过滤前瞻偏差

**发现者：小袋熊**

**问题**：日频 MA 过滤使用了**当天收盘价**判断是否持仓，相当于"今天暴跌了才决定今天不持仓"，实盘无法实现。

```python
# ❌ 有 bug 的写法（用当天价格）
btc_now = btc_p.loc[:day]          # 包含了今天的收盘价
btc_daily_above = btc_now.iloc[-1] > btc_ma.iloc[-1]

# ✅ 修复后（用前一天价格做信号，今天执行）
btc_now = btc_p.loc[:prev_day]     # 只用昨天收盘价
btc_daily_above = btc_now.iloc[-1] > btc_ma.iloc[-1]
```

### 修正后真实指标对比（2026-02-22 独立验证确认）

| 策略 | 版本 | CAGR | MaxDD | Sharpe | WF |
|---|---|---|---|---|---|
| v3 (w=20%) | 🚨 有前瞻(bug) | ~52.7% | -22.0% | ~2.10 | ~0.600 |
| v3 (w=20%) | ✅ 修复后 | **47.7%** | -22.0% | 1.91 | **0.559** ❌ |
| v5-D (w=20%) | 🚨 有前瞻(bug) | 55.8% | -22.1% | 1.99 | 0.649 |
| v5-D (w=20%) | ✅ 修复后 ☑️验证 | **48.3%** | -22.1% | 1.74 | **0.640** ✅ |
| v5-D (w=25%) | ✅ 修复后 ☑️验证 | **51.7%** | -25.1% | 1.70 | **0.635** ✅ |

> ☑️ "验证"表示当日独立运行代码确认的数字

### 修复后结论

v3 修复后 WF=0.559，**已跌破 0.60 阈值**，v5-D 修复后 WF=0.640，**仍满足部署条件**：
- WF:   v5-D(w=20%) **0.640** ✅ >> v3(w=20%) 0.559 ❌（差 +0.081）
- CAGR: v5-D(w=20%) **48.3%** > v3(w=20%) 47.7%
- MaxDD: 两者持平

**架构原则（更新）**：
> 日频过滤信号必须使用 `prev_day` 价格，当天收盘价只用于计算当天收益。

# 日频权益曲线审计报告 📊

> **作者**: 代码熊 🐻 | **日期**: 2026-02-21
> **目的**: 修复月频回测中 MaxDD 严重低估的缺陷

---

## 1. 问题背景

### 缺陷描述

当前所有策略回测代码使用月频采样：

```python
ends = rng.resample('ME').last().index  # 只取月末快照
```

这意味着**月中发生的暴跌完全看不见**。回测引擎只在月末记录一次净值，中间无论发生多大的跌幅，都被忽略。

### 影响范围

- **MaxDD 严重低估**: 真实 MaxDD 被隐藏
- **Calmar 虚高**: Calmar = CAGR / |MaxDD|，分母被低估
- **Composite 虚高**: Composite 包含 Calmar×0.4 权重
- **风险评估失真**: 实盘可能遭遇远超预期的回撤

---

## 2. 审计方法

### 日频净值追踪框架

- **调仓频率**: 月频（与原策略一致）
- **净值追踪**: 日频，使用 close[i-1] → close[i] 计算每日收益
- **T+1 滑点**: 月末信号生成后，下一个交易日才执行
- **时间段**: 2015-01 ~ 2025-12（与原回测一致）
- **成本**: 单边 0.15%（与原回测一致）

### 测试场景

| 场景 | 描述 |
|------|------|
| A. 无止损 | 仅修复日频净值，纯对比 |
| B. 月中止损 -15% | 月内跌 15% 切 SHY |
| C. 月中止损 -10% | 月内跌 10% 切 SHY |

---

## 3. 核心发现：月频 vs 日频 MaxDD 对比

### 3.1 所有策略对比总表

| 策略 | 月频 MaxDD | 日频 MaxDD | 差距 | 低估倍数 |
|------|-----------|-----------|------|---------|
| **Stock v9f** | -14.89% | **-26.51%** | -11.62% | **1.78x** |
| **Stock v9g** | -14.88% | **-26.51%** | -11.63% | **1.78x** |
| BTC v7f | -48.10% | -55.00% | -6.90% | 1.14x |
| BestCrypto | -56.93% | -66.25% | -9.32% | 1.16x |

### 关键发现

1. **股票策略 MaxDD 被低估近 1.8 倍！** 月频报告 -14.89%，真实值 -26.51%
2. **最大回撤区间**: 2020-02-20 → 2020-03-20（COVID-19 崩盘）
3. **加密策略低估较小** (1.14-1.16x)，因为加密本身波动大，月末采样已捕获大部分回撤
4. **所有 v9 系列策略的 MaxDD 几乎相同** (-26.51%)，说明 COVID 期间的暴跌是系统性的

### 3.2 Stock v9f 详细对比

| 指标 | 月频(原始) | 日频(无止损) | 日频(-15%止损) | 日频(-10%止损) |
|------|-----------|-------------|--------------|--------------|
| CAGR | 34.59% | 35.39% | 35.66% | 30.83% |
| MaxDD | -14.89% | **-26.51%** | **-26.51%** | **-25.86%** |
| Sharpe | 1.67 | 1.35 | 1.38 | 1.24 |
| Calmar | 2.32 | 1.34 | 1.35 | 1.19 |
| Composite | 1.6671 | 1.1464 | 1.1601 | 1.0364 |

### 3.3 Stock v9g 详细对比

| 指标 | 月频(原始) | 日频(无止损) | 日频(-15%止损) | 日频(-10%止损) |
|------|-----------|-------------|--------------|--------------|
| CAGR | 37.18% | 37.03% | 37.30% | 31.81% |
| MaxDD | -14.88% | **-26.51%** | **-26.51%** | **-25.86%** |
| Sharpe | 1.71 | 1.37 | 1.39 | 1.25 |
| Calmar | 2.50 | 1.40 | 1.41 | 1.23 |
| Composite | 1.7589 | 1.1812 | 1.1946 | 1.0564 |

### 3.4 Crypto 策略对比

#### BTC v7f DualMom

| 指标 | 月频采样 | 日频真实 |
|------|---------|---------|
| CAGR | 52.36% | 51.95% |
| MaxDD | -48.10% | **-55.00%** |
| Sharpe | 1.09 | 1.10 |
| Calmar | 1.09 | 0.94 |
| Composite | 0.9760 | 0.9228 |

**关键时期回撤**:
- 2018年 BTC Bear: MaxDD = **-54.75%**
- 2020年3月 COVID: MaxDD = -24.39%
- 2022年 Crypto Winter: MaxDD = -25.44%

#### BestCrypto (BTC+ETH+GLD)

| 指标 | 月频采样 | 日频真实 |
|------|---------|---------|
| CAGR | 112.48% | 110.65% |
| MaxDD | -56.93% | **-66.25%** |
| Sharpe | 1.24 | 1.49 |
| Calmar | 1.98 | 1.67 |
| Composite | 1.5122 | 1.4863 |

**关键时期回撤**:
- 2020年3月 COVID: MaxDD = **-34.94%**
- 2022年 Crypto Winter: MaxDD = **-43.05%**

---

## 4. 止损机制分析

### 4.1 止损效果

| 策略 | 日频无止损 | -15% 止损 | -10% 止损 |
|------|-----------|----------|----------|
| Stock v9f MaxDD | -26.51% | -26.51% | -25.86% |
| Stock v9g MaxDD | -26.51% | -26.51% | -25.86% |
| Stock v9f CAGR | 35.39% | 35.66% | 30.83% |
| Stock v9g CAGR | 37.03% | 37.30% | 31.81% |

### 4.2 为什么止损效果有限？

**核心原因: COVID-19 崩盘跨越两个月**

1. **2020年2月**: 市场在2月19日见顶后急剧下跌
   - 2月份组合已在1月末配置好，无法调整
   - 2月份跌幅 ~12%（未触发 -15% 月内止损）
   - -10% 止损会在2月底触发，切换到 SHY

2. **2020年3月**: 崩盘继续
   - 2月末重新调仓（DD 信号已触发部分 GLD 对冲）
   - 但3月份继续下跌 ~15%
   - 总计从2月顶到3月底: ~26.51%

3. **月内止损的局限性**:
   - 止损基于 `val / month_start_val - 1`（月内跌幅）
   - 跨月回撤无法被单月止损捕获
   - COVID 崩盘分布在2月和3月两个月，每个月单独看不到 26%

### 4.3 -10% 止损的代价

- CAGR 显著下降: v9f 35.39% → 30.83% (-4.56%), v9g 37.03% → 31.81% (-5.22%)
- 原因: -10% 门槛太敏感，在正常波动月份误触发

---

## 5. 对 Composite 的影响

### 5.1 Composite 重新计算

> Composite = Sharpe×0.4 + Calmar×0.4 + CAGR×0.2

| 策略 | 月频 Composite | 日频 Composite | 下降幅度 |
|------|---------------|---------------|---------|
| Stock v9g | **1.7589** | **1.1812** | -32.8% |
| Stock v9f | **1.6671** | **1.1464** | -31.2% |
| BTC v7f | 0.9760 | 0.9228 | -5.4% |
| BestCrypto | 1.5122 | 1.4863 | -1.7% |

### 5.2 排行榜校正

**校正前** (月频):
1. Stock v9g: Composite 1.759
2. Stock v9f: Composite 1.667
3. BestCrypto: Composite 1.512

**校正后** (日频):
1. BestCrypto: Composite **1.486** ← 跃居第一！
2. Stock v9g: Composite **1.181**
3. Stock v9f: Composite **1.146**

> ⚠️ **注意**: 日频 Sharpe 的计算方式（日收益年化）与月频 Sharpe（月收益年化）不同，
> 导致日频 Sharpe 系统性偏低。这不完全是"虚高"问题，而是两种不同频率的度量。
> **MaxDD 才是本次审计的核心关注点**。

---

## 6. 推荐的实盘参数

### 6.1 关于止损

**不推荐使用月内止损**，理由：

1. **效果有限**: 最大回撤来自跨月事件（COVID），月内止损无法有效应对
2. **误触发成本高**: -10% 止损导致 CAGR 下降 4-5%
3. **已有 DD 对冲机制**: v9f/v9g 已内置 DD-responsive GLD 对冲（-8%→40%GLD, -12%→60%, -18%→70%）

### 6.2 推荐实盘配置

| 参数 | 推荐值 | 理由 |
|------|--------|------|
| 调仓频率 | 月频 | 与回测一致 |
| 止损 | **不启用** | 已有 DD 对冲机制 |
| 预期 MaxDD | **-25% ~ -30%** | 日频真实值 |
| 预期 Calmar | **1.3 ~ 1.4** | 基于真实 MaxDD |
| 策略选择 | **v9g** | 日频 Composite 最高 (1.18) |

### 6.3 如果必须加止损

如果风险承受能力要求 MaxDD < -20%:
- 使用 **-15% 月内止损** 作为安全网
- 但要接受 CAGR 可能不变或微降
- 更有效的做法: **降低仓位** (如 80% 策略 + 20% SHY)

---

## 7. 为什么月频 Sharpe 比日频高？

这不是 bug，而是度量频率差异：

1. **月频 Sharpe**: `mean(月收益) / std(月收益) × √12`
   - 月内波动被平滑掉
   - 只看月末到月末的净变化

2. **日频 Sharpe**: `mean(日收益) / std(日收益) × √252`
   - 包含所有日内波动
   - 更真实但更"嘈杂"

**真实关系**: 日频 Sharpe 更接近实盘体验。月频 Sharpe 类似"季报投资者"的体验。

---

## 8. 结论

### 核心发现

1. 🚨 **股票策略 MaxDD 被月频回测低估 1.78 倍**
   - 报告值: -14.89%
   - 真实值: **-26.51%**
   - 原因: 2020年2-3月 COVID 崩盘跨越月界

2. 📊 **Calmar 和 Composite 需要校正**
   - v9g Calmar: 2.50 → 1.40 (真实)
   - v9g Composite: 1.76 → 1.18 (真实)

3. 💰 **CAGR 基本不受影响**
   - v9f: 34.59% → 35.39% (+0.80%)
   - v9g: 37.18% → 37.03% (-0.15%)

4. 🛑 **月内止损效果有限**
   - 不推荐使用，已有 DD 对冲机制更有效

5. 🏆 **v9g 仍然是最优股票策略**
   - 即使校正 MaxDD 后，v9g 日频 Composite (1.18) > v9f (1.15)

### 行动项

- [x] 创建 `momentum_v9f_daily.py` 和 `momentum_v9g_daily.py`
- [x] 完成所有策略的日频审计
- [x] 更新 BEST_STRATEGY.md 加注日频真实 MaxDD
- [x] 记录止损机制的实际效果
- [x] 提出实盘参数推荐

---

## 附录: 文件清单

| 文件 | 说明 |
|------|------|
| `stocks/codebear/daily_backtest_audit.py` | 审计框架主脚本 |
| `stocks/codebear/momentum_v9f_daily.py` | v9f 日频版本 |
| `stocks/codebear/momentum_v9g_daily.py` | v9g 日频版本 |
| `stocks/codebear/daily_backtest_audit_results.json` | 详细数值结果 |
| `DAILY_BACKTEST_AUDIT.md` | 本报告 |

---

*代码熊 🐻 — 2026-02-21*
